{% extends "base.html" %}

{% block title %}Dashboard - Foco Financeiro{% endblock %}

{% block content %}
    <h1 style="font-weight: 600;">Bem-vindo, {{ nome_usuario }}!</h1>

    <div class="painel-resumo" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 20px;">
        <div class="resumo-card" style="background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <h3 style="margin-top: 0; color: #6c757d; font-size: 1em;">Receitas do Mês</h3>
            <div class="valor positivo" id="total-receitas" style="font-size: 1.5em; font-weight: bold; color: #28a745;">Carregando...</div>
        </div>
        <div class="resumo-card" style="background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <h3 style="margin-top: 0; color: #6c757d; font-size: 1em;">Despesas do Mês</h3>
            <div class="valor negativo" id="total-despesas" style="font-size: 1.5em; font-weight: bold; color: #dc3545;">Carregando...</div>
        </div>
        <div class="resumo-card" style="background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <h3 style="margin-top: 0; color: #6c757d; font-size: 1em;">Saldo do Mês</h3>
            <div class="valor neutro" id="saldo-mes" style="font-size: 1.5em; font-weight: bold; color: #333;">Carregando...</div>
        </div>
    </div>

    <div class="card form-transacao">
        <h3>Adicionar Nova Transação</h3>
        <form action="{{ url_for('add_transacao') }}" method="POST" id="transacao-form">
            <input type="text" name="descricao" placeholder="Descrição (ex: Salário, Supermercado)" required>
            <input type="number" name="valor" step="0.01" placeholder="Valor (ex: 150.50)" required>
            <label for="data" style="margin-bottom: 5px; display: block;">Data:</label>
            <input type="date" name="data" required>
            <select name="tipo" id="tipo-select" required>
                <option value="receita">Receita</option>
                <option value="despesa">Despesa</option>
            </select>
            <div id="categoria-select-wrapper">
                <label for="categoria">Categoria:</label>
                <select name="categoria" id="categoria-select">
                    <option value="">-- Selecione uma categoria --</option>
                    {% for cat in categorias %}
                        <option value="{{ cat.id }}">{{ cat.nome }}</option>
                    {% endfor %}
                </select>
            </div>
            <button type="submit">Adicionar</button>
        </form>
    </div>

    <div class="card lista-transacoes">
        <h3>Suas Transações</h3>
        <table>
            <thead>
                <tr>
                    <th>Descrição</th>
                    <th>Valor</th>
                    <th>Categoria</th>
                    <th>Data</th>
                    <th>Ações</th>
                </tr>
            </thead>
            <tbody id="tabela-transacoes-corpo">
                <tr><td colspan="5" style="text-align: center;">Carregando transações...</td></tr>
            </tbody>
        </table>
    </div>
{% endblock %}

{% block scripts %}
<script>
    function formatarDinheiro(valor) {
        return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(valor);
    }

    async function carregarResumo() {
        try {
            const response = await fetch('/api/resumo');
            const data = await response.json();
            if (response.ok) {
                document.getElementById('total-receitas').textContent = formatarDinheiro(data.total_receitas);
                document.getElementById('total-despesas').textContent = formatarDinheiro(data.total_despesas);
                const saldoEl = document.getElementById('saldo-mes');
                saldoEl.textContent = formatarDinheiro(data.saldo_mes);
                saldoEl.className = 'valor';
                if (data.saldo_mes > 0) saldoEl.classList.add('positivo');
                else if (data.saldo_mes < 0) saldoEl.classList.add('negativo');
                else saldoEl.classList.add('neutro');
            } else { console.error('Erro ao buscar resumo:', data.erro); }
        } catch (error) { console.error('Fetch error:', error); }
    }

    async function carregarTransacoes() {
        try {
            const response = await fetch('/api/transacoes');
            const data = await response.json();
            const tabelaCorpo = document.getElementById('tabela-transacoes-corpo');
            tabelaCorpo.innerHTML = ''; 
            if (response.ok) {
                if (data.transacoes.length === 0) {
                    tabelaCorpo.innerHTML = '<tr><td colspan="5" style="text-align: center;">Nenhuma transação encontrada.</td></tr>';
                    return;
                }
                data.transacoes.forEach(t => {
                    const valorFormatado = formatarDinheiro(t.valor);
                    const classeValor = t.tipo === 'receita' ? 'receita' : 'despesa';
                    // --- ESTA É A LINHA CORRIGIDA (era ===a) ---
                    const sinalValor = t.tipo === 'receita' ? '+' : '-';
                    
                    const linha = `
                        <tr>
                            <td>${t.descricao}</td>
                            <td class="${classeValor}">${sinalValor} ${valorFormatado}</td>
                            <td>${t.categoria_nome !== 'N/A' ? `<span class="categoria-badge">${t.categoria_nome}</span>` : 'N/A'}</td>
                            <td>${t.data}</td>
                            <td class="actions">
                                <a href="/transacao/edit/${t.id}" class="edit">Editar</a>
                                <a href="/transacao/delete/${t.id}" class="delete" onclick="return confirm('Tem certeza?');">Excluir</a>
                            </td>
                        </tr>
                    `;
                    tabelaCorpo.innerHTML += linha;
                });
            } else {
                tabelaCorpo.innerHTML = `<tr><td colspan="5" style="text-align: center;">Erro ao carregar transações.</td></tr>`;
            }
        } catch (error) { console.error('Fetch error:', error); }
    }

    document.addEventListener('DOMContentLoaded', () => {
        carregarResumo();
        carregarTransacoes();
    });
</script>
{% endblock %}